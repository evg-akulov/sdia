@startuml

actor User

participant "API Gateway" as APIGW
participant "Query Service" as Query
participant "Query DB" as QueryDb
participant "Wallet Service" as Wallet
participant "Wallet DB" as WalletDb
participant "Wallet Cache" as Redis
participant "Kafka Broker" as Kafka
participant "Transactional DB" as TransactionalDb
participant "Transactional Service" as Transactional
participant "Callback Service" as Callback
participant "Callback DB" as CallbackDb
participant "External Payment Provider" as ExtProvider

User -> APIGW: POST (создать платёж)
APIGW -> Wallet: Запрос на платеж (сумма, получатель)

Wallet -> WalletDb: Дедупликация, если такой транзакции не было то продолжаем
Wallet -> WalletDb: Проверить баланс, если позволяет то продолжаем
Wallet -> WalletDb: Списать сумму в wallets (резерв средств)
Wallet -> WalletDb: Сохранить транзакцию в wallet_transactions (status=PENDING)
Wallet -> WalletDb: Записать событие\n"PaymentInitiated" в Outbox
Wallet --> WalletDb: commit (локальная транзакция)

Wallet -> Kafka: публикует событие PaymentInitiated\n(через Outbox + polling)

Kafka -> Transactional: доставить событие PaymentInitiated
Transactional -> TransactionalDb: Дедупликация по paymentId
Transactional -> TransactionalDb: Сохранить платеж (status=NEW)
Transactional -> ExtProvider: Вызвать API провайдера \n(списание средств)
Transactional -> TransactionalDb: Обновить статус платежа (status=SENT)
Kafka -> Query: доставить событие PaymentInitiated
Query -> QueryDb : Записать событие

ExtProvider -> APIGW: платеж успешен (SUCCESS)
APIGW -> Callback: платеж успешен (SUCCESS)

Callback -> CallbackDb : Записать событие\n"ProviderCallbackReceived" в Outbox
Callback -> Kafka: публикует событие ProviderCallbackReceived (SUCCESS)\n(через Outbox + polling)
Kafka -> Transactional: доставить событие ProviderCallbackReceived (SUCCESS)

Transactional -> Kafka: Если платеж был ранее отклонен(FAILED_TIMEOUT), то отправляем на ручной разбор
Transactional -> TransactionalDb: Обновить статус платежа\n(SUCCESS)
Transactional -> TransactionalDb: Записать событие \n"PaymentResult" в Outbox
Transactional --> TransactionalDb: commit (локальная транзакция)

Transactional -> Kafka: публикует событие PaymentResult (SUCCESS)

Kafka -> Query: доставить событие PaymentResult (SUCCESS)
Query -> QueryDb : Записать событие (SUCCESS)

Kafka -> Wallet: доставить событие PaymentResult (SUCCESS)\n
Wallet -> Redis: Дедупликация по paymentId + PaymentResultId
Wallet -> WalletDb: Подтвердить списание\n(окончательное списание)
Wallet -> WalletDb: Обновить статус транзакции = Completed
Wallet --> WalletDb: commit (локальная транзакция)
Wallet -> Redis: Записать paymentId + PaymentResultId


User -> APIGW: GET (получить данные по платёжу)
APIGW -> Query: Запрос на получение данных по платежу

@enduml